#-*- mode: Snakemake -*-

rule build_index:
	input:
		str(TARGETS_DIR+"/{ref}.fasta")
	output:
		str(TARGETS_DIR+"/{ref}.fasta.1.bt2")
#		str(config['align']['tar_dir']+"/{ref}.fasta.1.bt2")
	threads: 20
	shell:
		"bowtie2-build --threads {threads} -f {input} {input}"

rule process_alignment:
	input:
		str(OUTPUT_DIR+"/alignments/{ref}/{sample}.sam")
	output:
		bam = temp(str(OUTPUT_DIR+"/alignments/{ref}/{sample}.bam")),
		sorted = temp(str(OUTPUT_DIR+"/alignments/{ref}/{sample}.sorted.bam")),
		bai = temp(str(OUTPUT_DIR+"/alignments/{ref}/{sample}.sorted.bam.bai")),
	params:
                target = str(TARGETS_DIR+"/{ref}.fasta")		
	shell:
		"""
		samtools view -bT {params.target} {input} > {output.bam}
		samtools sort -o {output.sorted} {output.bam}
		samtools index {output.sorted} {output.bai}
		"""


